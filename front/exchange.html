<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Super Exchange</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        * {
           border: black 1px; 
        }
        img {
            object-fit: cover;
            min-width: inherit;
            max-width: inherit;
            min-height: inherit;
            max-height: inherit;
            height: inherit;
            width: inherit;
        }

        .card {
            width: 250px;
            height: 400px;
        }
    </style>
    <link rel="stylesheet" href="main.css" type="text/css"></link>
</head>

<body class="bg-info">
    <!-- supercards -->
    <div id="supercard" class="card col-6 col-sm-4 col-md-4 col-lg-3 col-xl-3 col-xxl-2 d-none">
        
        <h6 id="card_title" class="card-title text-light text-center"></h6>
        <svg onclick="remove(this);" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-excel-fill" viewBox="0 0 16 16"><path d="M12 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2M5.884 4.68 8 7.219l2.116-2.54a.5.5 0 1 1 .768.641L8.651 8l2.233 2.68a.5.5 0 0 1-.768.64L8 8.781l-2.116 2.54a.5.5 0 0 1-.768-.641L7.349 8 5.116 5.32a.5.5 0 1 1 .768-.64"/></svg>
        <img id="card_image" src="" class="card-img-top" alt="...">
        <!-- <div class="card-body">
            <p id="card_overview" class="card-text"></p>
        </div> -->
        <!-- <div class="card-footer">
            <a href="supercard.html" class="btn btn-primary">Dettagli</a>
        </div> -->
    </div>

    <div class="container">
        <nav id="navbar"></nav>
        <div class="divider-half"></div>

        <div class="row d-flex align-items-center">
            <div class="col">
                <h3>You offer</h3>
                <div id="container_offered" class="row row-cols-2 g-4 bg-info d-flex justify-content-around d-flex align-items-center">
                    <div id="supercard_offered" class="card col-6 col-sm-4 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                        <div class="d-flex align-items-center" style="height: inherit;">
                            <svg onclick="addOffered();" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16" data-bs-toggle="modal" data-bs-target="#cardChooserModal"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-2">
                <button onclick="exchange();" class="btn bg-light">Exchange</button>
                <button onclick="clearState();" class="btn bg-light">Clear</button>
                <button onclick="swapState();" class="btn bg-light">Swap</button>
            </div>
            <div class="col">
                <h3>You want</h3>
                <div id="container_wanted" class="row row-cols-2 g-4 bg-info d-flex justify-content-around d-flex align-items-center">
                    <div id="supercard_wanted" class="card col-6 col-sm-4 col-md-4 col-lg-3 col-xl-3 col-xxl-2">
                        <div class="d-flex align-items-center" style="height: inherit;">
                            <svg onclick="addWanted();" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16" data-bs-toggle="modal" data-bs-target="#cardChooserModal"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="shared/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="shared/lib.js"></script>
    <script>
        var page = 1;
        var pageSize = 100;
        var user_id = localStorage.getItem("user_id");
        var userAlbum = undefined;
        let exchangeState = new lib.ExchangeState();
        var card = document.getElementById('supercard');

        if(user_id === undefined) throw new Error("Unauthorized");

        async function getUserAlbum(container){
            const options = {
                "method": "GET",
                "headers": {
                    "Content-Type": "application/json",
                }
            };

            await fetch(`${url_backend}/album/${user_id}`, options)
                .then(response => {
                    if(response.ok){
                        response.json().then(json => {
                            userAlbum = json['supercards'];
                            showSupercards(userAlbum, container);
                        })
                    }
                });
        }

        // Adds an offered card to the left area
        function addOffered(){
            window.location.href = "album.html?op=offered";
        }

        // Adds a wanted card to the right area
        function addWanted(){
            window.location.href = "album.html?op=wanted";
        }

        // Exchanges the selected cards
        function exchange(){
            if(!exchangeState.isComplete()){
                console.log("Exchange is not complete!");
                return;
            }
        }

        // clears all the selected figures
        function clearState(){
            for(let id of exchangeState.offered){
                let e = document.getElementById(`supercard-offered-${id}`).remove();
            }
            for(let id of exchangeState.wanted){
                document.getElementById(`supercard-wanted-${id}`).remove();
            }

            exchangeState.clear();

            hideAddingCards();
        }

        // Show the current offered and wanted cards
        function showState(){
            showSelectedCards(exchangeState.offered, "offered");
            showSelectedCards(exchangeState.wanted, "wanted");
            hideAddingCards();
        }

        function swapState(){
            exchangeState.swap();
            window.location.reload();
        }

        // Takes the card's id to show and the operation associated
        // to determine if they are offered or wanted, asks the backend
        // for the data to show.
        // Doesn't return anything
        function showSelectedCards(cards, op){
            let container = document.getElementById(`container_${op}`);

            for(let cid of cards){
                const options = {
                    "method": "GET",
                    "headers": {
                        "Content-Type": "application/json",
                    }
                };

                fetch(`${url_backend}/characters/${cid}`, options)
                    .then(response => {
                        if(response.ok){
                            response.json().then(json => {
                                if(json.result === undefined) return;

                                let superhero = json.result;
                                let clone = card.cloneNode(true);
                                clone.id = `supercard-${op}-` + cid;

                                title = clone.getElementsByClassName('card-title')[0];
                                overview = clone.getElementsByClassName('card-text')[0];
                                image = clone.getElementsByClassName('card-img-top')[0];
                                button = clone.getElementsByClassName('btn-primary')[0];

                                title.innerHTML = superhero.name;
                                image.src = superhero['thumbnail'];

                                // set the rarity color on the supercard
                                clone.style.backgroundColor = `#${superhero.rarity}`;

                                clone.classList.remove('d-none')
                                container.appendChild(clone);
                            })
                        }
                    });
            }
        }

        // Removes the card
        function remove(callingElem){
            let operation = callingElem.parentNode.id.split("-")[1];
            let hero_id = Number(callingElem.parentNode.id.split("-")[2]);
            let cards = exchangeState[operation];

            callingElem.parentNode.remove();
            // The required method name is extracted from the capitalized
            // card id
            exchangeState.remove(operation, hero_id);

            hideAddingCards();
        }

        // Returns the string with the first letter capitalized
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function hideAddingCards(){
            if(exchangeState.sizeOffered() >= MAX_SELECTED_CARDS_EXCHANGE_PER_OP){
                document.getElementById("supercard_offered").classList.add("d-none");
            }else{
                document.getElementById("supercard_offered").classList.remove("d-none");
            }

            if(exchangeState.sizeWanted() >= MAX_SELECTED_CARDS_EXCHANGE_PER_OP){
                document.getElementById("supercard_wanted").classList.add("d-none");
            }else{
                document.getElementById("supercard_wanted").classList.remove("d-none");
            }
        }

        showState();
    </script>
</body>
</html>