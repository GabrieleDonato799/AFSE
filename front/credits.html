<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Album</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css" type="text/css"></link>
</head>

<body class="bg-info">
	<noscript>
		<button class="btn btn-danger disabled-js" type="submit">Please enable JS otherwise the site won't work!</button>
	</noscript>

    <div class="container bg-dark">
        <nav id="navbar"></nav>
        <div class="divider"></div>
        
        <h5 class="text-primary">Coins</h5>
        <div id="container_coins" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
            <div id="template_card" class="col d-none">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"></h5>
                        <p class="card-text"></p>
                        <img src="" class="card-img-top" alt="...">
                        <button onclick="buyCoins(this);" class="btn btn-primary">Click to buy</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="divider"></div>
        <h5 class="text-primary">Packets</h5>
        <div id="container_packets" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
            <div id="template_card" class="col d-none">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"></h5>
                        <p class="card-text"></p>
                        <img src="" class="card-img-top" alt="...">
                        <button class="btn btn-primary">Click for details</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared/lib.js"></script>
    <script src="shared/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="shared/api_marvel.js"></script>
    <script>
        var user_id = localStorage.getItem("user_id");
        var params = new URLSearchParams(window.location.search);

        if(user_id === undefined) throw new Error("Unauthorized");

        // Takes the offers to buy coins or packets and build their page layout
        function showOffers(offers){
            card = document.getElementById('template_card');

            for(let offer of offers) {
                if(offer.type !== "coins") continue;

                console.log(offer);
                clone = card.cloneNode(true);
                clone.id = 'offer-' + offer._id;


                title = clone.getElementsByClassName('card-title')[0];
                amount = clone.getElementsByClassName('card-text')[0];
                button = clone.getElementsByClassName('btn')[0];

                title.innerHTML = offer.title;
                amount.innerHTML = "Amount: " + offer.amount;

                clone.classList.remove('d-none')
                card.before(clone)
            }
        }

        async function getOffers(){
            await fetch(`${url_backend}/offers`, optionsGET)
                .then(response => {
                    if(response.ok){
                        response.json().then(json => {;
                            showOffers(json.offers);
                        })
                    }
                });
        }

        // Sends back to the exchange page the selected cards
        function backToExchange(){
            if(!exchangeState.checkOp(op)) return;
            window.location.href = `exchange.html`;
        }

        function buyCoins(callingElem){
            let id = callingElem.parentNode.parentNode.parentNode.id.split("-")[1];

            const options = {
                "method": "POST",
                "body": JSON.stringify(
                    {id: id}  
                ),
                "headers": {
                    "Content-Type": "application/json",
                }
            };

            fetch(`${url_backend}/offers/buy/${localStorage.getItem("user_id")}`, options)
                .then(response => {
                    if(response.ok){
                        response.json().then(json => {;
                            console.log(json);
							getUserBalance();
                        })
                    }
                });
        }

        getOffers();      
    </script>
</body>
</html>
