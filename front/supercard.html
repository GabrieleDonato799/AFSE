<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Supercard Details</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<link rel="stylesheet" href="main.css" type="text/css"></link>
	</head>
	<body>
		<div class="container">
			<nav id="navbar"></nav>
			<div class="divider-half"></div>
			<div id="supercard" class="card supercard col-6 col-sm-4 col-md-4 col-lg-3 col-xl-3 col-xxl-2 d-none">
				<h6 id="card_title" class="card-title text-light text-center supercard-title"></h6>
				<img id="card_image" src="" class="card-img-top card-img supercard-img" alt="...">
				<div class="card-footer">
					<a href="supercard.html" class="btn btn-primary">Dettagli</a>
				</div>
			</div>
			<div id="card_description" class="col-6"></div>
			<div id="comics-container" class="d-none">
				<h1>Comics</h1>
				<div class="row">
					<div id="comics" class="col-md-4 col-sm-6 d-none">
						<div class="card h-100">
							<div class="card-title"></div>
							<img class="card-img-top"
								onerror="this.error=null; this.src='http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available.jpg'">
							<div class="card-body">
								<p class="card-text"></p>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="series-container" class="d-none">
				<h1>Series</h1>
				<div class="row">
					<div id="series" class="col-md-4 col-sm-6 d-none">
						<div class="card h-100">
							<div class="card-title"></div>
							<img class="card-img-top"
								onerror="this.error=null; this.src='http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available.jpg'">
							<div class="card-body">
								<p class="card-text"></p>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="events-container" class="d-none">
				<h1>Events</h1>
				<div class="row">
					<div id="events" class="col-md-4 col-sm-6 d-none">
						<div class="card h-100">
							<div class="card-title"></div>
							<img class="card-img-top"
								onerror="this.error=null; this.src='http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available.jpg'">
							<div class="card-body">
								<p class="card-text"></p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>

	<script src="shared/lib.js"></script>
	<script src="shared/navbar.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
	<script src="shared/api_marvel.js"></script>
	<script>
		var params = new URLSearchParams(window.location.search);

		// Takes the character and the type of content to display ("comics"/"series"/"events"), creates six cards of the specified content and adds them to the page.
		async function showContent(character, type){
			if(typeof(type) !== "string") {console.log(`[showContent] invalid type`); return;}
			if(!character[type].available) return;
			let container = document.getElementById(`${type}-container`);
			let originalCard = document.getElementById(type);

			container.classList.remove('d-none');
			
			// retrieve the content and add a card asynchronously
			fetch(`${url_backend}/characters/${character.id}/${type}`, optionsGET)
			.then(res => {
				if(res.ok){
					content = res.json()
						.then(json => {
							console.log(json);
							let content = json.results;

							for(let i=0; i<6 && i<content.length; i++){
								let card = originalCard.cloneNode(true);
								let description = content[i].description;

								card.id = `${type}-${i}`;
								card.getElementsByClassName("card-title")[0].innerText = `${content[i].title}`;
								card.getElementsByClassName("card-img-top")[0].src = `${content[i].thumbnail.path}.${content[i].thumbnail.extension}`;
								if(description !== null)
									card.getElementsByClassName("card-text")[0].innerText = `${content[i].description}`;
								card.classList.remove('d-none');
								originalCard.parentNode.insertBefore(card, null);
							}
						});
					}
				}).catch(err => console.error(err));
		}

		function getContent(cid){
			fetch(`${url_backend}/characters/${cid}`, optionsGET)
				.then(response => {
					if(response.ok){
						response.json().then(json => {
							// This could be parallelized!
							console.log(`[getContent] cid: ${cid}`);
							console.log(json);
							showSupercard(json);
							showContent(json, "comics");
							showContent(json, "series");
							showContent(json, "events");
						})
					}else{
						response.json().then(error => {
							console.log(`Invalid character ${error.error}`);
						})
					}
				}).catch(err => {
				});
		}

		function showSupercard(superhero){
            let card = document.getElementById('supercard');
			card.id = 'supercard-' + superhero.id;

			let title = card.getElementsByClassName('card-title')[0];
			let overview = card.getElementsByClassName('card-text')[0];
			let image = card.getElementsByClassName('card-img-top')[0];
			let button = card.getElementsByClassName('btn-primary')[0];
			let footer = card.getElementsByClassName('card-footer')[0];
			let card_description = document.getElementById("card_description");
			
			title.innerHTML = superhero.name;
			// console.log(`[showSupercard] superhero['thumbnail']:`);
			// console.log(superhero['thumbnail']);
			image.src = superhero['thumbnail'];
			footer.firstElementChild.search = `?cid=${superhero.id}`;
			card_description.innerText = `${superhero.description}`;

			// set the rarity color on the supercard
			// card.style.backgroundColor = `#${superhero.rarity}`;
			card.style.backgroundColor = "#1aa3ff";

			card.classList.remove('d-none')
		}

		getContent(params.get("cid"));
	</script>
</html>
