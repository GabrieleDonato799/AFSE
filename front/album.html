<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Album</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css" type="text/css"></link>
</head>

<body class="bg-info">
    <div class="container">
        <nav id="navbar"></nav>
        <div class="divider-half"></div>
        
        <div class="row d-flex justify-content-between">
            <button class="col btn bg-light" onclick='previousPage();'>Pagina precedente</button>
            <button class="col btn bg-light" onclick='nextPage();'>Pagina successiva</button>
            <button id="exchange_button" class="col btn bg-light d-none" onclick='backToExchange();'>Back to exchange</button>
        </div>
        <div class="divider-half"></div>
        <div id="container" class="row row-cols-2 g-4 bg-info d-flex justify-content-around">
            <div id="supercard" onclick="select(this);" class="card supercard col-6 col-sm-4 col-md-4 col-lg-3 col-xl-3 col-xxl-2 d-none">
                <h6 id="card_title" class="card-title text-light text-center supercard-title"></h6>
                <img id="card_image" src="" class="card-img-top card-img supercard-img" alt="...">
                <!-- <div class="card-body">
                    <p id="card_overview" class="card-text"></p>
                </div> -->
                <div class="card-footer">
                    <a href="supercard.html" class="btn btn-primary">Dettagli</a>
                </div>
            </div>
        </div>
    </div>
    <div class="divider-half"></div>
    <div class="container bg-info">
        <div class="row d-flex justify-content-between">
            <button class="col btn bg-light" onclick='previousPage();'>Pagina precedente</button>
            <button class="col btn bg-light" onclick='nextPage();'>Pagina successiva</button>
            <button id="exchange_button" class="col btn bg-light d-none" onclick='backToExchange();'>Back to exchange</button>
        </div>
    </div>
    
    <script src="shared/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="shared/api_marvel.js"></script>
    <script src="shared/lib.js"></script>
    <script>
        const MAX_SELECTED = 4;
        const PAGE_SIZE = 20;
        var page = 0;
        var user_id = localStorage.getItem("user_id");
        var userAlbum = undefined;
        var params = new URLSearchParams(window.location.search);
        var op = params.get("op");
        // var selected = new Set(); // eventually selected supercards for an exchange
        let exchangeState = new lib.ExchangeState();

        if(exchangeState.checkOp(op)){
            document.getElementById("exchange_button").classList.remove("d-none");
        }

        if(user_id === undefined) throw new Error("Unauthorized");

        function nextPage(){
            page += 1;
            showSupercards(userAlbum);
        }

        function previousPage(){
            if(page > 0)
                page -= 1;
            showSupercards(userAlbum);
        }

        function showSupercards(response){
            card = document.getElementById('supercard');
            container = document.getElementById('container');
            container.innerHTML = "";
            container.append(card);

            
           

            // for(let sub of ["LEGO Marvel Super Heroes", "Ultimate", "Marvel War of Heroes", "Marvel: Avengers Alliance", "HAS", "MAA", "Deadpool", "House of M", "Age of Apocalypse", "X-Men: Battle of the Atom", "Iron Man 3 - The Official Game", "Marvel Heroes", "Marvel Zombies", "USM"]){
            //     let count =0;
            //     for (let i = 0; i < response.length; i++) {
            //         let superhero = response[i];
            //         if(superhero.name.includes(sub)) count++;
            //     }
            //     console.log(`${sub}: ${count}`);
            // }

            // for (let i = 0; i < response.length; i++) {
            for (i = page*PAGE_SIZE; i < Math.min(response.length, (page+1)*PAGE_SIZE); i++) {
                let superhero = response[i];

                clone = card.cloneNode(true);
                clone.id = 'supercard-' + superhero.id;

                title = clone.getElementsByClassName('card-title')[0];
                overview = clone.getElementsByClassName('card-text')[0];
                image = clone.getElementsByClassName('card-img-top')[0];
                button = clone.getElementsByClassName('btn-primary')[0];

                title.innerHTML = superhero.name;
                image.src = superhero['thumbnail'];

                // set the rarity color on the supercard
                clone.style.backgroundColor = `#${superhero.rarity}`;

                clone.classList.remove('d-none')
                card.before(clone)
            }
        }

        async function getUserAlbum(){
            const options = {
                "method": "GET",
                "headers": {
                    "Content-Type": "application/json",
                }
            };

            await fetch(`${url_backend}/album/${user_id}`, options)
                .then(response => {
                    if(response.ok){
                        response.json().then(json => {
                            userAlbum = json['supercards'];
                            showSupercards(userAlbum);
                        })
                    }
                });
        }

        function select(callingElem){
            if(!exchangeState.checkOp(op)) return;

            let size = exchangeState.size(op);
            
            if(size < MAX_SELECTED_CARDS_EXCHANGE_PER_OP){
                let idToAdd = Number(callingElem.id.split("-")[1]);

                exchangeState.add(op, idToAdd);
            }else{
                // Error
            }
        }

        // Sends back to the exchange page the selected cards
        function backToExchange(){
            if(!exchangeState.checkOp(op)) return;
            window.location.href = `exchange.html`;
        }

        getUserAlbum();      
    </script>
</body>
</html>